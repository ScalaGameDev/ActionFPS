<link rel="canonical" href="/register-play/"/>
<div id="questions">

    <h1>Register &amp; Play!</h1>

    <h2>1. Log in with your Google account</h2>
    <div class="g-signin2" data-onsuccess="onSignIn"></div>

    <div id="reg-form">
        <h2>2. Register an ActionFPS account</h2>

        <div id="register-waiting">
            <p>Please sign in</p>
        </div>

        <div id="register-signedin">

            <form class="pure-form pure-form-aligned" id="reg_form" method="post" enctype="multipart/form-data"
                  action="https://script.google.com/macros/s/AKfycbw2na0_P4atptBWe_AXn2TJECge8POwV-3ai5QGJ2hd25TffWtY/exec">
                <fieldset>

                    <div class="pure-control-group">
                        <label for="nickname">Nickname</label>
                        <input name="nickname" id="field-nickname" type="text"
                               placeholder="In-game nickname, e.g. w00p|Drakas" pattern="[^\s]+{3,15}">
                        <p>Anything valid, 3 characters minimum.</p>
                    </div>

                    <div class="pure-control-group">
                        <label for="name">Username</label>
                        <input name="name" id="field-username" type="text"
                               placeholder="Simple name, without clan tag, e.g. Drakas" pattern="[A-Z]?[a-z]{3,15}">
                        <p>First letter can be uppercase, the rest must be lowercase</p>
                    </div>

                    <div class="pure-control-group">
                        <label for="id">User ID</label>
                        <input type="text" id="field-id" name="id"
                               placeholder="3 or more a-z characters, e.g. drakas" pattern="[a-z]{3,10}"/>
                        <p>Lowercase letters only.</p>
                        <p>Your profile will be available at <code>https://actionfps.com/player/?id=<span
                                id="player-id-value"></span></code></p>
                    </div>
                    <input type="hidden" name="token" id="token"/>
                    <input type="hidden" name="redirect" value="true"/>

                    <div class="pure-controls">
                        <button type="submit" class="pure-button pure-button-primary">Register</button>
                    </div>
                </fieldset>
            </form>

        </div>

    </div>

    <h2>3. Install the game</h2>

    <p><a href="/download-direct/game/?os=windows"
          class="pure-button pure-button-primary">Download ActionFPS (Windows, 42MB download)</a></p>
    <p><a href="/download-direct/game/?os=linux"
          class="pure-button pure-button-primary">Download ActionFPS (Linux, 47MB download)</a></p>

    <section id="authenticate">
    <h2>4. Play</h2>

    <p><a class="button-error pure-button" id="connect-link">Click here to play (with authentication).</a></p>

    <p>This will load your user account credentials into the game so you can play on the official servers.</p>
    </section>

    <p><a href="/servers/" class="button-warning pure-button">Server list</a></p>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

    <meta name="google-signin-client_id"
          content="566822418457-bqerpiju1kajn53d8qumc6o8t2mn0ai9.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script type="text/javascript">
        $("#field-nickname").on("keyup", function (v) {
            var nickname = $(v.target).val();
            var newUsername = nickname.replace(/[^A-Za-z]/g, '');
            newUsername = newUsername[0] + newUsername.substring(1).toLowerCase();
            var newId = newUsername.toLowerCase();
            $('#field-id').val(newId);
            $('#field-username').val(newUsername);
            $('#player-id-value').text(newId);
        });
        $("#field-id").on("keyup", function (v) {
            $('#player-id-value').text($(v.target).val());
        })
    </script>
    <script type="text/javascript">
        var authSection = document.querySelector("#authenticate");
        authSection.setAttribute("style", "display:none");
        var rootUrl = "https://script.google.com/macros/s/AKfycbw2na0_P4atptBWe_AXn2TJECge8POwV-3ai5QGJ2hd25TffWtY/exec";
        function onSignIn(googleUser) {
            $("#reg-form").addClass("signed-in");
            var profile = googleUser.getAuthResponse();
            $("#token").val(profile.id_token);
            console.log("token", profile.id_token);
            var queryUrl = rootUrl + "?email=" + googleUser.getBasicProfile().getEmail();
            $.get(queryUrl).then(function (x) {
                if (x === false) {
                } else if ("id" in x) {
                    $.cookie("af_id", x.id, {path: '/', expires: 100});
                    $.cookie("af_name", x.name, {path: '/', expires: 100});
                    $('#login_welcome a').attr("href", "/player/?id=" + x.id).text(x.name);
                    $('#welcome-user, #log-in').attr("href", "/player/?id=" + x.id).text(x.name);
                    $('#login_welcome').css("display", "block");
                    $('#reg-form').remove();

                    $.post("/user/auth-token/", {"id_token": profile.id_token})
                        .done(function (data) {
                            authSection.setAttribute("style", "");
                            document.querySelector("#connect-link").setAttribute("href", "actionfps://woop.ac:7654?id=" + data.user + "&key=" + data.privKey);
                        })
                }
            })
        }
    </script>
</div>
